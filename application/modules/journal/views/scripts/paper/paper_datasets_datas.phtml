<?php
$datasets = $this->datasets;
$paper = $this->paper;
$listSources = $this->listSources;
$keepOnlySourceUsed = [];
?>
<div class="panel panel-default collapsable">
    <div class="panel-heading">
        <h2 class="panel-title"><?= $this->translate('Datasets') ?></h2>
    </div>
    <div class="panel-body in">
        <?php foreach ($datasets as $source => $datasetsArrayBySource) : ?>
            <?php
            $getSource = new Episciences_Paper_Dataset();
            $getSource->setSourceId($source);
            $getSource = $getSource->getSourceLabel($source);
            ?>
            <?php foreach ($datasetsArrayBySource as $dataset) : /** @var Episciences_Paper_Dataset $dataset */ ?>
                <?php if ((string) $source === Episciences_Repositories::EPI_USER_ID && (Episciences_Auth::isAllowedToManagePaper() || $paper->isOwner())): ?>
                    <button id="remove-ld" data-ld="<?= $dataset->getId() ?>" class="btn btn-default btn-xs" type="button" ><i class="fa-solid fa-trash-can"></i></button>
                <?php endif;?>
                <?php if ($dataset->getRelationship() !== null){echo $this->escape($this->translate($dataset->getRelationship()));} ?>&nbsp;<?= ucfirst($this->translate($dataset->getName())) ?>
                <?php if ((string) $source !== Episciences_Repositories::EPI_USER_ID) : ?>
                    <sup><?=$listSources[$getSource]?></sup>
                <?php endif;?>
                <a href="<?= $dataset->getLink() ?>" target="_blank" rel="noopener" id="link-ld"><?= $dataset->getValue() ?></a><br>
                <div style="margin-bottom: 4px"></div>
            <?php endforeach; ?>
            <?php if ((string) $source !== Episciences_Repositories::EPI_USER_ID && !array_key_exists($getSource,$keepOnlySourceUsed)){ $keepOnlySourceUsed[$listSources[$getSource]] = array_search($listSources[$getSource],$listSources);} ?>
        <?php endforeach; ?>
        <ul class="list-unstyled">
            <?php foreach ($keepOnlySourceUsed as $id => $label): ?>
                <li><span class="label label-default"><?=$this->escape($id)?></span> <?= $label ?></li>
            <?php endforeach; ?>
        </ul>
        <?php if (Episciences_Auth::isAllowedToManageOrcidAuthor() || $paper->isOwner()): ?>
            <a class="btn btn-default btn-sm" id="anchor-dataset-add" href="#manage-linked-data"><span class="fas fa-database" style="margin-right: 5px"></span><?= $this->translate("Ajouter un jeu de donnÃ©es") ?></a>
        <?php endif; ?>
    </div>
</div>
