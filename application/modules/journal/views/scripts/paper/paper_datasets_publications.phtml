<?php
$publications = $this->publications;
$paper = $this->paper;
$listSources = $this->listSources;
$keepOnlySourceUsed = [];
?>
<div class="panel panel-default collapsable">
    <div class="panel-heading">
        <h2 class="panel-title"><?= $this->translate('Publications') ?></h2>
    </div>
    <div class="panel-body in">
        <?php foreach ($publications as $source => $publicationArrayBySource) : ?>
            <?php
            $getSource = new Episciences_Paper_Dataset();
            $getSource->setSourceId($source);
            $getSource = $getSource->getSourceLabel($source);
            ?>
            <?php foreach ($publicationArrayBySource as $publication) : /** @var Episciences_Paper_Dataset $publication */ ?>
                <?php if ((string) $source === Episciences_Repositories::EPI_USER_ID && (Episciences_Auth::isAllowedToManagePaper() || $paper->isOwner())): ?>
                    <button id="remove-ld" data-ld="<?= $publication->getId() ?>" class="btn btn-default btn-xs" type="button" ><i class="fa-solid fa-trash-can"></i></button>
                <?php endif;?>
                <?php if ($publication->getRelationship() !== null){echo $this->escape($this->translate($publication->getRelationship()));} ?>&nbsp;<?= ucfirst($this->translate($publication->getName())) ?>
                <?php if ((string) $source !== Episciences_Repositories::EPI_USER_ID) : ?>
                    <sup><?=$listSources[$getSource]?></sup>
                <?php endif;?>
                <a href="<?= $publication->getLink() ?>" target="_blank" rel="noopener" id="link-ld"><?= $publication->getValue() ?></a><br>
                <?php if ((string) $source === Episciences_Repositories::SCHOLEXPLORER_ID && $publication->getMetatext() !== null) {
                    $decodedMetatext = json_decode($publication->getMetatext(), true, 512, JSON_THROW_ON_ERROR);
                    echo $this->partial('paper/paper_linked_data_metadatas.phtml', ['metadatas' => $decodedMetatext]);
                } ?>
            <?php endforeach; ?>
            <?php if ((string) $source !== Episciences_Repositories::EPI_USER_ID && !array_key_exists($getSource,$keepOnlySourceUsed)) {$keepOnlySourceUsed[$listSources[$getSource]] = array_search($listSources[$getSource],$listSources);} ?>
        <?php endforeach; ?>
        <ul class="list-unstyled">
            <?php foreach ($keepOnlySourceUsed as $id => $label): ?>
                <li><span class="label label-default"><?=$this->escape($id)?></span> <?= $label ?></li>
            <?php endforeach; ?>
        </ul>
        <?php if (Episciences_Auth::isAllowedToManageOrcidAuthor() || $paper->isOwner()): ?>
            <a class="btn btn-default btn-sm" href="#manage-linked-data" id="anchor-publication-add"><span class="fa-regular fa-file-lines" style="margin-right: 5px"></span><?= $this->translate("Ajouter une publication") ?></a>
        <?php endif; ?>
    </div>
</div>
